<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gelora Mycelium Network - Bagua GPS Navigation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        body { 
            margin: 0; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        #arScene {
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* Compass overlay */
        .compass-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Touch points positioned as compass with trigram info */
        .touch-point {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 50%, transparent 70%);
            border: 2px solid rgba(255,255,255,0.5);
            cursor: pointer;
            pointer-events: all;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        
        .touch-point .direction {
            font-weight: bold;
            font-size: 14px;
        }
        
        .touch-point .trigram {
            font-size: 16px;
            margin-top: 2px;
        }
        
        .touch-point:hover {
            transform: scale(1.2);
            background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.2) 50%, transparent 70%);
            box-shadow: 0 0 20px rgba(255,255,255,0.6);
        }
        
        .touch-point.active {
            animation: pulse 2s infinite;
            background: radial-gradient(circle, rgba(255,215,0,0.4) 0%, rgba(255,215,0,0.2) 50%, transparent 70%);
            border-color: rgba(255,215,0,0.8);
        }
        
        .touch-point.revealed {
            background: radial-gradient(circle, rgba(138,43,226,0.5) 0%, rgba(138,43,226,0.3) 50%, transparent 70%);
            border-color: rgba(138,43,226,0.9);
            box-shadow: 0 0 30px rgba(138,43,226,0.8);
        }
        
        .touch-point.loading {
            animation: pulse 1s infinite;
            background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.2) 50%, transparent 70%);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,215,0,0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255,215,0,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,215,0,0); }
        }
        
        /* Compass positions */
        #north { top: 10%; left: 50%; transform: translateX(-50%); }
        #south { bottom: 10%; left: 50%; transform: translateX(-50%); }
        #east { right: 10%; top: 50%; transform: translateY(-50%); }
        #west { left: 10%; top: 50%; transform: translateY(-50%); }
        #northeast { top: 20%; right: 20%; }
        #northwest { top: 20%; left: 20%; }
        #southeast { bottom: 20%; right: 20%; }
        #southwest { bottom: 20%; left: 20%; }
        
        /* Info panel */
        .info-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 20;
            backdrop-filter: blur(10px);
            max-width: 80%;
        }
        
        .info-panel h3 {
            margin-top: 0;
            font-size: 1.5em;
            color: #FFD700;
        }
        
        .info-panel .subtitle {
            font-size: 0.9em;
            color: #DDD;
            margin: 10px 0;
            line-height: 1.4;
        }
        
        .info-panel button {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 1em;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: black;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        /* GPS info display - iPhone compass style */
        #compassData {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 13px;
            z-index: 100;
            text-align: center;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Bagua reveal notification */
        #baguaReveal {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(138,43,226,0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 16px;
            z-index: 100;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(138,43,226,0.8);
            animation: slideDown 0.5s ease;
            pointer-events: none;
        }
        
        @keyframes slideDown {
            from { top: 0; opacity: 0; }
            to { top: 20%; opacity: 1; }
        }
        
        #baguaReveal .trigram-large {
            font-size: 48px;
            margin: 10px 0;
        }
        
        #baguaReveal .trigram-name {
            font-size: 20px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        /* Connection lines - historical Bagua pattern */
        .mycelium-connection {
            position: absolute;
            background: linear-gradient(90deg, transparent, rgba(138,43,226,0.4), transparent);
            height: 2px;
            transform-origin: left center;
            pointer-events: none;
            animation: flow 3s linear infinite;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        .mycelium-connection.active {
            opacity: 1;
        }
        
        @keyframes flow {
            0% { background-position: -100px 0; }
            100% { background-position: 100px 0; }
        }
        
        /* Loading seed indicator */
        #loadingSeed {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            z-index: 50;
            pointer-events: none;
            transition: opacity 0.5s ease-out;
        }
        
        #loadingSeed.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .seed-core {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, 
                rgba(255, 215, 0, 0.9) 0%, 
                rgba(255, 215, 0, 0.6) 30%,
                rgba(255, 215, 0, 0.2) 60%,
                transparent 100%);
            border-radius: 50%;
            animation: seedPulse 2s ease-in-out infinite;
        }
        
        @keyframes seedPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
        }
        
        /* Center Taiji symbol */
        .center-taiji {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            pointer-events: none;
            z-index: 5;
        }
    </style>
</head>
<body>
    <!-- Info Panel -->
    <div class="info-panel" id="infoPanel">
        <h3>GELORA MYCELIUM NETWORK</h3>
        <p class="subtitle">八卦 Bagua: Eight Trigrams</p>
        <p class="subtitle">Reference Point: Mount Kunlun 崑崙山<br>
        36°N, 84°E - Axis Mundi<br>
        <small>Palace of Xi Wangmu, Queen Mother of the West</small></p>
        <p>TOUCH THE CIRCLES</p>
        <p><small>Your bearing from Kunlun reveals the trigram</small></p>
        <button onclick="startExperience()">BEGIN</button>
    </div>
    
    <!-- Loading seed indicator -->
    <div id="loadingSeed" class="hidden">
        <div class="seed-core"></div>
    </div>
    
    <!-- Bagua reveal notification -->
    <div id="baguaReveal" class="hidden"></div>
    
    <!-- GPS compass data -->
    <div id="compassData" class="hidden">
        <span id="coordinates">---</span> <span id="locationValue">---</span> <span id="elevationValue">--- ft Elevation</span><br>
        <span id="bearingInfo" style="color: #FFD700; font-weight: bold;">---</span>
    </div>
    
    <!-- AR Scene -->
    <a-scene
        id="arScene"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        vr-mode-ui="enabled: false"
        renderer="antialias: true; alpha: true">
        
        <a-camera 
            gps-camera 
            rotation-reader
            look-controls-enabled="false"
            arjs-look-controls="smoothingFactor: 0.1">
        </a-camera>
    </a-scene>
    
    <!-- Compass Touch Interface with Trigrams - Later Heaven Bagua arrangement -->
    <div class="compass-overlay">
        <!-- Center Taiji symbol -->
        <div class="center-taiji">☯</div>
        
        <div class="touch-point" id="north" data-direction="north">
            <span class="direction">N</span>
            <span class="trigram">☵</span>
        </div>
        <div class="touch-point" id="northeast" data-direction="northeast">
            <span class="direction">NE</span>
            <span class="trigram">☶</span>
        </div>
        <div class="touch-point" id="east" data-direction="east">
            <span class="direction">E</span>
            <span class="trigram">☳</span>
        </div>
        <div class="touch-point" id="southeast" data-direction="southeast">
            <span class="direction">SE</span>
            <span class="trigram">☴</span>
        </div>
        <div class="touch-point" id="south" data-direction="south">
            <span class="direction">S</span>
            <span class="trigram">☲</span>
        </div>
        <div class="touch-point" id="southwest" data-direction="southwest">
            <span class="direction">SW</span>
            <span class="trigram">☷</span>
        </div>
        <div class="touch-point" id="west" data-direction="west">
            <span class="direction">W</span>
            <span class="trigram">☱</span>
        </div>
        <div class="touch-point" id="northwest" data-direction="northwest">
            <span class="direction">NW</span>
            <span class="trigram">☰</span>
        </div>
        
        <!-- Mycelium connection lines - historical Bagua pattern -->
        <div id="connections"></div>
    </div>
    
    <script>
        // Mount Kunlun - Mythological Reference Point
        // The Axis Mundi of Chinese cosmology
        const KUNLUN_LAT = 36.0;
        const KUNLUN_LNG = 84.0;
        
        // Trigram configuration - Later Heaven (King Wen) Bagua
        // Includes historical correspondences
        const trigrams = {
            'north': { 
                model: 'model2.glb', 
                name: 'KAN 坎',
                chinese: '☵ 坎 Water',
                element: 'Water',
                meaning: 'The Abyss, Danger',
                color: '#000080',
                season: 'Winter'
            },
            'southwest': { 
                model: 'model1.glb', 
                name: 'KUN 坤',
                chinese: '☷ 坤 Earth',
                element: 'Earth',
                meaning: 'The Receptive, Mother Earth',
                color: '#8B4513',
                season: 'Late Summer'
            },
            'east': { 
                model: 'model7.glb', 
                name: 'ZHEN 震',
                chinese: '☳ 震 Thunder',
                element: 'Wood',
                meaning: 'The Arousing, Thunder',
                color: '#228B22',
                season: 'Spring'
            },
            'southeast': { 
                model: 'model8.glb', 
                name: 'XUN 巽',
                chinese: '☴ 巽 Wind',
                element: 'Wood',
                meaning: 'The Gentle, Wind',
                color: '#90EE90',
                season: 'Late Spring'
            },
            'south': { 
                model: 'model3.glb', 
                name: 'LI 離',
                chinese: '☲ 離 Fire',
                element: 'Fire',
                meaning: 'The Clinging, Fire',
                color: '#FF0000',
                season: 'Summer'
            },
            'northwest': { 
                model: 'model4.glb', 
                name: 'QIAN 乾',
                chinese: '☰ 乾 Heaven',
                element: 'Metal',
                meaning: 'The Creative, Heaven',
                color: '#FFD700',
                season: 'Late Autumn'
            },
            'west': { 
                model: 'model5.glb', 
                name: 'DUI 兌',
                chinese: '☱ 兌 Lake',
                element: 'Metal',
                meaning: 'The Joyous, Lake',
                color: '#C0C0C0',
                season: 'Autumn'
            },
            'northeast': { 
                model: 'model6.glb', 
                name: 'GEN 艮',
                chinese: '☶ 艮 Mountain',
                element: 'Earth',
                meaning: 'Keeping Still, Mountain',
                color: '#8B7355',
                season: 'Late Winter'
            }
        };
        
        let activeModels = new Set();
        let loadQueue = [];
        let isLoading = false;
        let userLat = 0;
        let userLon = 0;
        let scene;
        let currentBagua = null;
        
        // Distance in meters from user for models
        const DISTANCE = 1.8;
        
        // Calculate bearing between two GPS points
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRad = (deg) => deg * Math.PI / 180;
            const toDeg = (rad) => rad * 180 / Math.PI;
            
            const dLon = toRad(lon2 - lon1);
            const y = Math.sin(dLon) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                      Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
            
            let bearing = toDeg(Math.atan2(y, x));
            bearing = (bearing + 360) % 360; // Normalize to 0-360
            
            return bearing;
        }
        
        // Map bearing to Bagua direction (Later Heaven arrangement)
        function bearingToBagua(bearing) {
            // Later Heaven Bagua directions (45° sectors)
            const sectors = {
                north:     { min: 337.5, max: 22.5 },   // 0°
                northeast: { min: 22.5, max: 67.5 },    // 45°
                east:      { min: 67.5, max: 112.5 },   // 90°
                southeast: { min: 112.5, max: 157.5 },  // 135°
                south:     { min: 157.5, max: 202.5 },  // 180°
                southwest: { min: 202.5, max: 247.5 },  // 225°
                west:      { min: 247.5, max: 292.5 },  // 270°
                northwest: { min: 292.5, max: 337.5 }   // 315°
            };
            
            // Handle north crossing 0°
            if (bearing >= 337.5 || bearing < 22.5) return 'north';
            
            for (const [direction, range] of Object.entries(sectors)) {
                if (bearing >= range.min && bearing < range.max) {
                    return direction;
                }
            }
            
            return 'north'; // fallback
        }
        
        function startExperience() {
            document.getElementById('infoPanel').classList.add('hidden');
            document.getElementById('compassData').classList.remove('hidden');
            
            scene = document.querySelector('a-scene');
            
            // Initialize GPS and compass
            initCompassAndLocation();
            initializeTouchPoints();
        }
        
        // Convert decimal degrees to DMS format
        function toDMS(decimal, isLat) {
            const absolute = Math.abs(decimal);
            const degrees = Math.floor(absolute);
            const minutesDecimal = (absolute - degrees) * 60;
            const minutes = Math.floor(minutesDecimal);
            const seconds = Math.round((minutesDecimal - minutes) * 60);
            
            const direction = isLat ? 
                (decimal >= 0 ? 'N' : 'S') : 
                (decimal >= 0 ? 'E' : 'W');
            
            return `${degrees}°${minutes}'${seconds}"${direction}`;
        }
        
        // Initialize compass and geolocation
        function initCompassAndLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    handlePosition,
                    handleLocationError,
                    { enableHighAccuracy: true }
                );
                
                navigator.geolocation.watchPosition(
                    handlePosition,
                    handleLocationError,
                    { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
                );
            }
        }
        
        // Handle geolocation position and calculate Bagua
        function handlePosition(position) {
            const coords = position.coords;
            userLat = coords.latitude;
            userLon = coords.longitude;
            
            // Calculate bearing from user to Mount Kunlun
            const bearing = calculateBearing(userLat, userLon, KUNLUN_LAT, KUNLUN_LNG);
            const direction = bearingToBagua(bearing);
            const bagua = trigrams[direction];
            
            // Update current Bagua
            if (currentBagua !== direction) {
                currentBagua = direction;
                highlightRevealedBagua(direction, bagua, bearing);
            }
            
            // Format coordinates
            const latDMS = toDMS(userLat, true);
            const lonDMS = toDMS(userLon, false);
            document.getElementById('coordinates').textContent = `${latDMS} ${lonDMS}`;
            
            // Bearing info
            document.getElementById('bearingInfo').textContent = 
                `Bearing to Kunlun: ${Math.round(bearing)}° → ${bagua.chinese}`;
            
            // Convert altitude
            const elevationFeet = coords.altitude ? Math.round(coords.altitude * 3.28084) : 0;
            document.getElementById('elevationValue').textContent = `${elevationFeet} ft Elevation`;
            
            // Reverse geocoding
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLon}&zoom=18`)
                .then(response => response.json())
                .then(data => {
                    const address = data.address || {};
                    const city = address.suburb || 
                                address.city_district || 
                                address.neighbourhood || 
                                address.city || 
                                address.town || 
                                address.village || '';
                    
                    const state = address.state || address.region || '';
                    
                    let locationText = '';
                    if (city && state) {
                        locationText = `${city}, ${state}`;
                    } else if (city || state) {
                        locationText = city || state;
                    }
                    
                    document.getElementById('locationValue').textContent = locationText;
                })
                .catch(err => {
                    document.getElementById('locationValue').textContent = '';
                });
        }
        
        // Highlight the revealed Bagua based on GPS
        function highlightRevealedBagua(direction, bagua, bearing) {
            // Remove previous highlights
            document.querySelectorAll('.touch-point').forEach(point => {
                point.classList.remove('revealed');
            });
            
            // Highlight current direction
            const touchPoint = document.getElementById(direction);
            if (touchPoint) {
                touchPoint.classList.add('revealed');
            }
            
            // Show reveal notification
            const revealDiv = document.getElementById('baguaReveal');
            revealDiv.innerHTML = `
                <div class="trigram-large">${bagua.chinese.split(' ')[0]}</div>
                <div class="trigram-name">${bagua.name}</div>
                <div>${bagua.element} • ${bagua.meaning}</div>
                <div style="font-size: 12px; margin-top: 10px;">Bearing: ${Math.round(bearing)}°</div>
            `;
            revealDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                revealDiv.classList.add('hidden');
            }, 5000);
        }
        
        // Handle location errors
        function handleLocationError(error) {
            console.warn('Location error:', error);
            document.getElementById('coordinates').textContent = '---';
            document.getElementById('locationValue').textContent = '';
            document.getElementById('elevationValue').textContent = '--- ft Elevation';
            document.getElementById('bearingInfo').textContent = 'Enable location to reveal Bagua';
        }
        
        function initializeTouchPoints() {
            const touchPoints = document.querySelectorAll('.touch-point');
            
            touchPoints.forEach(point => {
                point.addEventListener('click', (e) => {
                    activateModel(e.currentTarget);
                });
                
                point.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    activateModel(e.currentTarget);
                });
            });
        }
        
        function activateModel(touchPoint) {
            const direction = touchPoint.dataset.direction;
            const modelId = `model-${direction}`;
            
            if (activeModels.has(modelId)) {
                hideModel(modelId);
                activeModels.delete(modelId);
                touchPoint.classList.remove('active', 'loading');
            } else {
                loadQueue.push({ touchPoint, direction, modelId });
                processLoadQueue();
            }
            
            updateConnections();
        }
        
        function processLoadQueue() {
            if (isLoading || loadQueue.length === 0) return;
            
            isLoading = true;
            const { touchPoint, direction, modelId } = loadQueue.shift();
            
            touchPoint.classList.add('loading');
            document.getElementById('loadingSeed').classList.remove('hidden');
            
            setTimeout(() => {
                showModel(direction, modelId, touchPoint);
            }, 500);
        }
        
        function showModel(direction, modelId, touchPoint) {
            const config = trigrams[direction];
            
            // 3D positions forming a perfect circle
            const radius = 2.5;
            const positions3D = {
                north:     { x: 0,                y: 0.5, z: -radius },
                northeast: { x: radius * 0.707,   y: 0.5, z: -radius * 0.707 },
                east:      { x: radius,           y: 0.5, z: -1 },
                southeast: { x: radius * 0.707,   y: 0.5, z: radius * 0.707 - 1 },
                south:     { x: 0,                y: 0.5, z: radius - 1 },
                southwest: { x: -radius * 0.707,  y: 0.5, z: radius * 0.707 - 1 },
                west:      { x: -radius,          y: 0.5, z: -1 },
                northwest: { x: -radius * 0.707,  y: 0.5, z: -radius * 0.707 }
            };
            
            const pos3D = positions3D[direction];
            
            const model = document.createElement('a-entity');
            model.setAttribute('id', modelId);
            model.setAttribute('gltf-model', `./models/${config.model}`);
            model.setAttribute('position', '0 -1.5 -1.5');
            model.setAttribute('scale', '0.05 0.05 0.05');
            model.setAttribute('visible', true);
            
            scene.appendChild(model);
            
            model.addEventListener('model-loaded', () => {
                touchPoint.classList.remove('loading');
                touchPoint.classList.add('active');
                document.getElementById('loadingSeed').classList.add('hidden');
                
                startGrowthAnimation(model, pos3D);
                
                activeModels.add(modelId);
                updateConnections();
                
                isLoading = false;
                processLoadQueue();
            });
            
            setTimeout(() => {
                if (touchPoint.classList.contains('loading')) {
                    touchPoint.classList.remove('loading');
                    document.getElementById('loadingSeed').classList.add('hidden');
                    isLoading = false;
                    processLoadQueue();
                }
            }, 10000);
        }
        
        function startGrowthAnimation(model, targetPos) {
            // Mycelium emergence animation
            model.setAttribute('animation__grow1', {
                property: 'scale',
                from: '0.05 0.05 0.05',
                to: '0.3 0.3 0.3',
                dur: 4000,
                easing: 'easeInOutQuad'
            });
            
            model.setAttribute('animation__rise1', {
                property: 'position',
                from: '0 -1.5 -1.5',
                to: '0 -0.5 -1.5',
                dur: 4000,
                easing: 'easeInOutQuad'
            });
            
            setTimeout(() => {
                model.setAttribute('animation__spread', {
                    property: 'position',
                    from: '0 -0.5 -1.5',
                    to: `${targetPos.x} ${targetPos.y} ${targetPos.z}`,
                    dur: 6000,
                    easing: 'easeInOutSine'
                });
                
                model.setAttribute('animation__grow2', {
                    property: 'scale',
                    from: '0.3 0.3 0.3',
                    to: '0.8 0.8 0.8',
                    dur: 6000,
                    easing: 'easeInOutSine'
                });
            }, 4500);
            
            setTimeout(() => {
                model.setAttribute('animation__pulse', {
                    property: 'scale',
                    from: '0.8 0.8 0.8',
                    to: '0.9 0.9 0.9',
                    dur: 4000,
                    loop: true,
                    dir: 'alternate',
                    easing: 'easeInOutSine'
                });
            }, 11000);
        }
        
        function hideModel(modelId) {
            const model = document.getElementById(modelId);
            if (!model) return;
            
            model.removeAttribute('animation__pulse');
            const currentPos = model.getAttribute('position');
            
            model.setAttribute('animation__return', {
                property: 'position',
                from: `${currentPos.x} ${currentPos.y} ${currentPos.z}`,
                to: '0 -1.5 -1.5',
                dur: 2500,
                easing: 'easeInExpo'
            });
            
            model.setAttribute('animation__shrink', {
                property: 'scale',
                to: '0.05 0.05 0.05',
                dur: 2500,
                easing: 'easeInQuad'
            });
            
            setTimeout(() => {
                if (model && model.parentNode) {
                    model.parentNode.removeChild(model);
                }
            }, 2600);
        }
        
        // Update connections - historical Bagua pattern
        // Creates lines between all active trigrams forming mycelium network
        function updateConnections() {
            const container = document.getElementById('connections');
            container.innerHTML = '';
            
            const activePoints = document.querySelectorAll('.touch-point.active');
            
            // Connect all active points (full mesh network)
            for (let i = 0; i < activePoints.length; i++) {
                for (let j = i + 1; j < activePoints.length; j++) {
                    createConnection(activePoints[i], activePoints[j]);
                }
            }
        }
        
        function createConnection(point1, point2) {
            const rect1 = point1.getBoundingClientRect();
            const rect2 = point2.getBoundingClientRect();
            
            const x1 = rect1.left + rect1.width / 2;
            const y1 = rect1.top + rect1.height / 2;
            const x2 = rect2.left + rect2.width / 2;
            const y2 = rect2.top + rect2.height / 2;
            
            const distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const angle = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);
            
            const connection = document.createElement('div');
            connection.className = 'mycelium-connection';
            connection.style.width = distance + 'px';
            connection.style.left = x1 + 'px';
            connection.style.top = y1 + 'px';
            connection.style.transform = `rotate(${angle}deg)`;
            
            document.getElementById('connections').appendChild(connection);
            
            setTimeout(() => {
                connection.classList.add('active');
            }, 10);
        }
    </script>
</body>
</html>
