<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mycelium Network - GPS Waypoints</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        body { 
            margin: 0; 
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        /* GPS & Compass Info - Top Right */
        #locationInfo {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 20;
            min-width: 200px;
        }
        
        #locationInfo .label {
            color: #aaa;
            font-size: 10px;
            margin-top: 8px;
        }
        
        #locationInfo .value {
            font-size: 14px;
            font-weight: bold;
            color: white;
        }
        
        #compass {
            text-align: center;
            margin-top: 10px;
            font-size: 24px;
            color: #4CAF50;
        }
        
        /* Compass Visual - Center Top */
        #compassVisual {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 200px;
            z-index: 15;
        }
        
        .compass-circle {
            width: 100%;
            height: 100%;
            border: 3px solid rgba(255,255,255,0.5);
            border-radius: 50%;
            position: relative;
            background: radial-gradient(circle, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.3) 100%);
        }
        
        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 80px;
            background: linear-gradient(180deg, red 0%, red 50%, white 50%, white 100%);
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            transition: transform 0.3s ease;
        }
        
        .compass-direction {
            position: absolute;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 5px black;
        }
        
        .compass-direction.active {
            color: #4CAF50;
            font-size: 20px;
            text-shadow: 0 0 10px #4CAF50;
        }
        
        #compassN { top: 5px; left: 50%; transform: translateX(-50%); }
        #compassE { top: 50%; right: 5px; transform: translateY(-50%); }
        #compassS { bottom: 5px; left: 50%; transform: translateX(-50%); }
        #compassW { top: 50%; left: 5px; transform: translateY(-50%); }
        #compassNE { top: 20px; right: 20px; font-size: 12px; }
        #compassSE { bottom: 20px; right: 20px; font-size: 12px; }
        #compassSW { bottom: 20px; left: 20px; font-size: 12px; }
        #compassNW { top: 20px; left: 20px; font-size: 12px; }
        
        /* Waypoint Status - Bottom */
        #waypointStatus {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            z-index: 20;
            text-align: center;
        }
        
        .waypoint-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .waypoint-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.3s;
        }
        
        .waypoint-dot.found {
            background: #4CAF50;
            border-color: #4CAF50;
            box-shadow: 0 0 20px #4CAF50;
        }
        
        .waypoint-dot.near {
            background: rgba(255, 193, 7, 0.5);
            border-color: #FFC107;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        /* Info Panel */
        .info-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 30;
            max-width: 80%;
        }
        
        .info-panel h3 {
            margin-top: 0;
            font-size: 1.5em;
        }
        
        .info-panel button {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 1em;
            background: white;
            color: black;
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }
        
        .hidden {
            display: none;
        }
        
        /* Setup panel for GPS configuration */
        #setupPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 30px;
            border-radius: 20px;
            z-index: 30;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }
        
        #setupPanel input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 5px;
        }
        
        #setupPanel button {
            margin: 10px 5px;
            padding: 10px 20px;
            background: white;
            color: black;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Setup Panel -->
    <div id="setupPanel">
        <h3>Setup GPS Waypoints</h3>
        <p>Set 8 GPS locations where each model will appear.</p>
        
        <button onclick="useCurrentLocation()">Use My Current Location as Center</button>
        <button onclick="useCustomLocations()">Enter Custom Locations</button>
        
        <div id="customInputs" class="hidden">
            <p><small>Enter latitude, longitude for each direction:</small></p>
            <div>
                <strong>North:</strong><br>
                <input type="text" id="lat_north" placeholder="Latitude">
                <input type="text" id="lon_north" placeholder="Longitude">
            </div>
            <div>
                <strong>Northeast:</strong><br>
                <input type="text" id="lat_northeast" placeholder="Latitude">
                <input type="text" id="lon_northeast" placeholder="Longitude">
            </div>
            <div>
                <strong>East:</strong><br>
                <input type="text" id="lat_east" placeholder="Latitude">
                <input type="text" id="lon_east" placeholder="Longitude">
            </div>
            <div>
                <strong>Southeast:</strong><br>
                <input type="text" id="lat_southeast" placeholder="Latitude">
                <input type="text" id="lon_southeast" placeholder="Longitude">
            </div>
            <div>
                <strong>South:</strong><br>
                <input type="text" id="lat_south" placeholder="Latitude">
                <input type="text" id="lon_south" placeholder="Longitude">
            </div>
            <div>
                <strong>Southwest:</strong><br>
                <input type="text" id="lat_southwest" placeholder="Latitude">
                <input type="text" id="lon_southwest" placeholder="Longitude">
            </div>
            <div>
                <strong>West:</strong><br>
                <input type="text" id="lat_west" placeholder="Latitude">
                <input type="text" id="lon_west" placeholder="Longitude">
            </div>
            <div>
                <strong>Northwest:</strong><br>
                <input type="text" id="lat_northwest" placeholder="Latitude">
                <input type="text" id="lon_northwest" placeholder="Longitude">
            </div>
            <button onclick="saveCustomLocations()">Save and Start</button>
        </div>
    </div>
    
    <!-- Location Info - Top Right -->
    <div id="locationInfo" class="hidden">
        <div class="label">Your Location</div>
        <div class="value"><span id="userLat">-</span></div>
        <div class="value"><span id="userLon">-</span></div>
        <div class="label" style="margin-top: 15px;">Heading</div>
        <div id="compass">-</div>
        <div class="label" style="margin-top: 15px;">Found</div>
        <div class="value"><span id="foundCount">0</span>/8</div>
    </div>
    
    <!-- Compass Visual - Center Top -->
    <div id="compassVisual" class="hidden">
        <div class="compass-circle">
            <div class="compass-needle" id="needle"></div>
            <div class="compass-direction" id="compassN">N</div>
            <div class="compass-direction" id="compassNE">NE</div>
            <div class="compass-direction" id="compassE">E</div>
            <div class="compass-direction" id="compassSE">SE</div>
            <div class="compass-direction" id="compassS">S</div>
            <div class="compass-direction" id="compassSW">SW</div>
            <div class="compass-direction" id="compassW">W</div>
            <div class="compass-direction" id="compassNW">NW</div>
        </div>
    </div>
    
    <!-- Waypoint Status - Bottom -->
    <div id="waypointStatus" class="hidden">
        <div style="font-size: 14px; margin-bottom: 5px;">Mycelium Network</div>
        <div class="waypoint-grid">
            <div class="waypoint-dot" data-direction="north">N</div>
            <div class="waypoint-dot" data-direction="northeast">NE</div>
            <div class="waypoint-dot" data-direction="east">E</div>
            <div class="waypoint-dot" data-direction="southeast">SE</div>
            <div class="waypoint-dot" data-direction="south">S</div>
            <div class="waypoint-dot" data-direction="southwest">SW</div>
            <div class="waypoint-dot" data-direction="west">W</div>
            <div class="waypoint-dot" data-direction="northwest">NW</div>
        </div>
    </div>
    
    <!-- AR Scene -->
    <a-scene
        id="arScene"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        vr-mode-ui="enabled: false"
        renderer="antialias: true; alpha: true">
        
        <a-camera 
            gps-camera 
            rotation-reader
            look-controls-enabled="false"
            arjs-look-controls="smoothingFactor: 0.1">
        </a-camera>
    </a-scene>
    
    <script>
        let userLat = 0;
        let userLon = 0;
        let userHeading = 0;
        let scene;
        let foundModels = new Set();
        let activeModels = new Set();
        
        // GPS waypoints for each direction (will be set during setup)
        let waypoints = {};
        
        // Proximity threshold in meters
        const PROXIMITY_THRESHOLD = 10; // Model appears when within 10 meters
        const NEAR_THRESHOLD = 20; // "Near" indicator when within 20 meters
        
        // Model mapping
        const modelMapping = {
            north: { num: 1, position: { x: 0, y: 0, z: -0.8 } },
            northeast: { num: 8, position: { x: 0.6, y: 0, z: -0.6 } },
            east: { num: 3, position: { x: 0.8, y: 0, z: 0 } },
            southeast: { num: 4, position: { x: 0.6, y: 0, z: 0.6 } },
            south: { num: 5, position: { x: 0, y: 0, z: 0.8 } },
            southwest: { num: 2, position: { x: -0.6, y: 0, z: 0.6 } },
            west: { num: 7, position: { x: -0.8, y: 0, z: 0 } },
            northwest: { num: 6, position: { x: -0.6, y: 0, z: -0.6 } }
        };
        
        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const centerLat = position.coords.latitude;
                        const centerLon = position.coords.longitude;
                        
                        // Generate waypoints 15 meters away in each direction
                        waypoints = generateWaypoints(centerLat, centerLon, 15);
                        
                        startExperience();
                    },
                    (error) => {
                        alert('GPS access required. Error: ' + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        function useCustomLocations() {
            document.getElementById('customInputs').classList.remove('hidden');
        }
        
        function saveCustomLocations() {
            waypoints = {
                north: {
                    lat: parseFloat(document.getElementById('lat_north').value),
                    lon: parseFloat(document.getElementById('lon_north').value)
                },
                northeast: {
                    lat: parseFloat(document.getElementById('lat_northeast').value),
                    lon: parseFloat(document.getElementById('lon_northeast').value)
                },
                east: {
                    lat: parseFloat(document.getElementById('lat_east').value),
                    lon: parseFloat(document.getElementById('lon_east').value)
                },
                southeast: {
                    lat: parseFloat(document.getElementById('lat_southeast').value),
                    lon: parseFloat(document.getElementById('lon_southeast').value)
                },
                south: {
                    lat: parseFloat(document.getElementById('lat_south').value),
                    lon: parseFloat(document.getElementById('lon_south').value)
                },
                southwest: {
                    lat: parseFloat(document.getElementById('lat_southwest').value),
                    lon: parseFloat(document.getElementById('lon_southwest').value)
                },
                west: {
                    lat: parseFloat(document.getElementById('lat_west').value),
                    lon: parseFloat(document.getElementById('lon_west').value)
                },
                northwest: {
                    lat: parseFloat(document.getElementById('lat_northwest').value),
                    lon: parseFloat(document.getElementById('lon_northwest').value)
                }
            };
            
            startExperience();
        }
        
        function generateWaypoints(centerLat, centerLon, distance) {
            const latOffset = distance / 111000;
            const lonOffset = distance / (111000 * Math.cos(centerLat * Math.PI / 180));
            
            return {
                north:     { lat: centerLat + latOffset,          lon: centerLon },
                northeast: { lat: centerLat + latOffset * 0.7,    lon: centerLon + lonOffset * 0.7 },
                east:      { lat: centerLat,                      lon: centerLon + lonOffset },
                southeast: { lat: centerLat - latOffset * 0.7,    lon: centerLon + lonOffset * 0.7 },
                south:     { lat: centerLat - latOffset,          lon: centerLon },
                southwest: { lat: centerLat - latOffset * 0.7,    lon: centerLon - lonOffset * 0.7 },
                west:      { lat: centerLat,                      lon: centerLon - lonOffset },
                northwest: { lat: centerLat + latOffset * 0.7,    lon: centerLon - lonOffset * 0.7 }
            };
        }
        
        function startExperience() {
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('locationInfo').classList.remove('hidden');
            document.getElementById('compassVisual').classList.remove('hidden');
            document.getElementById('waypointStatus').classList.remove('hidden');
            
            scene = document.querySelector('a-scene');
            
            // Watch user position and heading
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLon = position.coords.longitude;
                        
                        document.getElementById('userLat').textContent = userLat.toFixed(6);
                        document.getElementById('userLon').textContent = userLon.toFixed(6);
                        
                        checkProximity();
                    },
                    null,
                    {
                        enableHighAccuracy: true,
                        maximumAge: 0
                    }
                );
            }
            
            // Watch device orientation for compass
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }
        
        function handleOrientation(event) {
            if (event.alpha !== null) {
                userHeading = event.alpha;
                
                // Update compass needle
                document.getElementById('needle').style.transform = 
                    `translate(-50%, -100%) rotate(${userHeading}deg)`;
                
                // Update compass text
                const direction = getCompassDirection(userHeading);
                document.getElementById('compass').textContent = direction;
                
                // Highlight active direction
                updateCompassHighlight(direction);
            }
        }
        
        function getCompassDirection(heading) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(heading / 45) % 8;
            return directions[index];
        }
        
        function updateCompassHighlight(direction) {
            // Remove all active classes
            document.querySelectorAll('.compass-direction').forEach(el => {
                el.classList.remove('active');
            });
            
            // Add active to current direction
            const dirMap = {
                'N': 'compassN', 'NE': 'compassNE', 'E': 'compassE', 'SE': 'compassSE',
                'S': 'compassS', 'SW': 'compassSW', 'W': 'compassW', 'NW': 'compassNW'
            };
            
            if (dirMap[direction]) {
                document.getElementById(dirMap[direction]).classList.add('active');
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function checkProximity() {
            Object.keys(waypoints).forEach(direction => {
                const waypoint = waypoints[direction];
                const distance = calculateDistance(userLat, userLon, waypoint.lat, waypoint.lon);
                
                const dot = document.querySelector(`.waypoint-dot[data-direction="${direction}"]`);
                
                if (distance <= PROXIMITY_THRESHOLD && !foundModels.has(direction)) {
                    // Found! Show model
                    foundModels.add(direction);
                    dot.classList.add('found');
                    dot.classList.remove('near');
                    showModel(direction);
                    
                    document.getElementById('foundCount').textContent = foundModels.size;
                } else if (distance <= NEAR_THRESHOLD && !foundModels.has(direction)) {
                    // Near
                    dot.classList.add('near');
                } else {
                    // Far
                    dot.classList.remove('near');
                }
            });
        }
        
        function showModel(direction) {
            const mapping = modelMapping[direction];
            const modelId = `model-${direction}`;
            
            if (activeModels.has(modelId)) return;
            
            const waypoint = waypoints[direction];
            const pos3D = mapping.position;
            
            // Create model
            const model = document.createElement('a-entity');
            model.setAttribute('id', modelId);
            model.setAttribute('gltf-model', `./models/model${mapping.num}.glb`);
            model.setAttribute('gps-entity-place', `latitude: ${waypoint.lat}; longitude: ${waypoint.lon};`);
            model.setAttribute('position', '0 0 -0.5');
            model.setAttribute('scale', '0 0 0');
            
            scene.appendChild(model);
            activeModels.add(modelId);
            
            // Animate
            setTimeout(() => {
                model.setAttribute('animation__grow', {
                    property: 'scale',
                    from: '0 0 0',
                    to: '0.2 0.2 0.2',
                    dur: 1800,
                    easing: 'easeOutQuad'
                });
                
                setTimeout(() => {
                    model.setAttribute('animation__spread', {
                        property: 'position',
                        from: '0 0 -0.5',
                        to: `${pos3D.x} ${pos3D.y} ${pos3D.z}`,
                        dur: 2000,
                        easing: 'easeOutExpo'
                    });
                    
                    model.setAttribute('animation__fullgrow', {
                        property: 'scale',
                        from: '0.2 0.2 0.2',
                        to: '0.4 0.4 0.4',
                        dur: 2000,
                        easing: 'easeOutElastic'
                    });
                }, 1800);
                
                setTimeout(() => {
                    model.setAttribute('animation__rotate', {
                        property: 'rotation',
                        to: '0 360 0',
                        dur: 10000,
                        loop: true,
                        easing: 'linear'
                    });
                    
                    model.setAttribute('animation__float', {
                        property: 'position.y',
                        from: pos3D.y,
                        to: pos3D.y + 0.2,
                        dur: 3000,
                        loop: true,
                        dir: 'alternate',
                        easing: 'easeInOutSine'
                    });
                }, 3800);
            }, 100);
        }
    </script>
</body>
</html>
