<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gelora Mycelium Network Overview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <style>
        body { 
            margin: 0; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        #arScene {
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* Compass overlay */
        .compass-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Touch points positioned as compass with trigram info */
        .touch-point {
            position: absolute;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 50%, transparent 70%);
            border: 2px solid rgba(255,255,255,0.5);
            cursor: pointer;
            pointer-events: all;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        
        .touch-point .direction {
            font-weight: bold;
            font-size: 14px;
        }
        
        .touch-point .trigram {
            font-size: 16px;
            margin-top: 2px;
        }
        
        .touch-point:hover {
            transform: scale(1.2);
            background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.2) 50%, transparent 70%);
            box-shadow: 0 0 20px rgba(255,255,255,0.6);
        }
        
        .touch-point.active {
            animation: pulse 2s infinite;
        }
        
        .touch-point.loading {
            animation: heartbeat 1s infinite;
            background: radial-gradient(circle, rgba(255,100,100,0.5) 0%, rgba(255,100,100,0.2) 50%, transparent 70%);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255,255,255,0); }
            100% { box-shadow: 0 0 0 0 rgba(255,255,255,0); }
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Compass positions */
        #north { top: 10%; left: 50%; transform: translateX(-50%); }
        #south { bottom: 10%; left: 50%; transform: translateX(-50%); }
        #east { right: 10%; top: 50%; transform: translateY(-50%); }
        #west { left: 10%; top: 50%; transform: translateY(-50%); }
        #northeast { top: 20%; right: 20%; }
        #northwest { top: 20%; left: 20%; }
        #southeast { bottom: 20%; right: 20%; }
        #southwest { bottom: 20%; left: 20%; }
        
        /* Info panel */
        .info-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 20;
            backdrop-filter: blur(10px);
            max-width: 80%;
        }
        
        .info-panel h3 {
            margin-top: 0;
            font-size: 1.5em;
        }
        
        .info-panel button {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 1em;
            background: white;
            color: black;
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }
        
        .hidden {
            display: none;
        }
        
        /* GPS info display - iPhone compass style */
        #compassData {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 13px;
            z-index: 100;
            text-align: center;
            white-space: nowrap;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Connection lines */
        .mycelium-connection {
            position: absolute;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            height: 2px;
            transform-origin: left center;
            pointer-events: none;
            animation: flow 3s linear infinite;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        .mycelium-connection.active {
            opacity: 1;
        }
        
        @keyframes flow {
            0% { background-position: -100px 0; }
            100% { background-position: 100px 0; }
        }
        
        /* Loading seed indicator */
        #loadingSeed {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            z-index: 50;
            pointer-events: none;
            transition: opacity 0.5s ease-out;
        }
        
        #loadingSeed.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .seed-core {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(255, 255, 255, 0.6) 30%,
                rgba(255, 255, 255, 0.2) 60%,
                transparent 100%);
            border-radius: 50%;
            animation: seedPulse 2s ease-in-out infinite;
        }
        
        @keyframes seedPulse {
            0%, 100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Info Panel -->
    <div class="info-panel" id="infoPanel">
        <h3>Mycelium Network</h3>
        <p>八卦 Bagua - Eight Trigrams</p>
        <p>Touch the compass points to activate each direction's model.</p>
        <p><small>Models represent the eight fundamental forces of nature.</small></p>
        <button onclick="startExperience()">Begin</button>
    </div>
    
    <!-- Loading seed indicator -->
    <div id="loadingSeed" class="hidden">
        <div class="seed-core"></div>
    </div>
    
    <!-- GPS compass data - iPhone style -->
    <div id="compassData" class="hidden">
        <span id="coordinates">---</span> <span id="locationValue">---</span> <span id="elevationValue">--- ft Elevation</span>
    </div>
    
    <!-- AR Scene -->
    <a-scene
        id="arScene"
        embedded
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
        vr-mode-ui="enabled: false"
        renderer="antialias: true; alpha: true">
        
        <a-camera 
            gps-camera 
            rotation-reader
            look-controls-enabled="false"
            arjs-look-controls="smoothingFactor: 0.1">
        </a-camera>
    </a-scene>
    
    <!-- Compass Touch Interface with Trigrams -->
    <div class="compass-overlay">
        <div class="touch-point" id="north" data-direction="north">
            <span class="direction">N</span>
            <span class="trigram">☵</span>
        </div>
        <div class="touch-point" id="northeast" data-direction="northeast">
            <span class="direction">NE</span>
            <span class="trigram">☶</span>
        </div>
        <div class="touch-point" id="east" data-direction="east">
            <span class="direction">E</span>
            <span class="trigram">☳</span>
        </div>
        <div class="touch-point" id="southeast" data-direction="southeast">
            <span class="direction">SE</span>
            <span class="trigram">☴</span>
        </div>
        <div class="touch-point" id="south" data-direction="south">
            <span class="direction">S</span>
            <span class="trigram">☲</span>
        </div>
        <div class="touch-point" id="southwest" data-direction="southwest">
            <span class="direction">SW</span>
            <span class="trigram">☷</span>
        </div>
        <div class="touch-point" id="west" data-direction="west">
            <span class="direction">W</span>
            <span class="trigram">☱</span>
        </div>
        <div class="touch-point" id="northwest" data-direction="northwest">
            <span class="direction">NW</span>
            <span class="trigram">☰</span>
        </div>
        
        <!-- Mycelium connection lines -->
        <div id="connections"></div>
    </div>
    
    <script>
        // Trigram model mapping - matching your current implementation
        const trigrams = {
            'north': { 
                model: 'model2.glb', 
                name: 'NORTH',
                chinese: '☵ 坎 Water'
            },
            'southwest': { 
                model: 'model1.glb', 
                name: 'SOUTHWEST',
                chinese: '☷ 坤 Earth'
            },
            'east': { 
                model: 'model7.glb', 
                name: 'EAST',
                chinese: '☳ 震 Thunder'
            },
            'southeast': { 
                model: 'model8.glb', 
                name: 'SOUTHEAST',
                chinese: '☴ 巽 Wind'
            },
            'south': { 
                model: 'model3.glb', 
                name: 'SOUTH',
                chinese: '☲ 離 Fire'
            },
            'northwest': { 
                model: 'model4.glb', 
                name: 'NORTHWEST',
                chinese: '☰ 乾 Heaven'
            },
            'west': { 
                model: 'model5.glb', 
                name: 'WEST',
                chinese: '☱ 兌 Lake'
            },
            'northeast': { 
                model: 'model6.glb', 
                name: 'NORTHEAST',
                chinese: '☶ 艮 Mountain'
            }
        };
        
        let activeModels = new Set();
        let loadQueue = [];
        let isLoading = false;
        let userLat = 0;
        let userLon = 0;
        let scene;
        
        // Distance in meters from user for models
        const DISTANCE = 1.8;
        
        function startExperience() {
            document.getElementById('infoPanel').classList.add('hidden');
            document.getElementById('compassData').classList.remove('hidden');
            
            scene = document.querySelector('a-scene');
            
            // Initialize GPS and compass
            initCompassAndLocation();
            initializeTouchPoints();
        }
        
        // Convert decimal degrees to DMS (degrees, minutes, seconds) format
        function toDMS(decimal, isLat) {
            const absolute = Math.abs(decimal);
            const degrees = Math.floor(absolute);
            const minutesDecimal = (absolute - degrees) * 60;
            const minutes = Math.floor(minutesDecimal);
            const seconds = Math.round((minutesDecimal - minutes) * 60);
            
            const direction = isLat ? 
                (decimal >= 0 ? 'N' : 'S') : 
                (decimal >= 0 ? 'E' : 'W');
            
            return `${degrees}°${minutes}'${seconds}"${direction}`;
        }
        
        // Initialize compass and geolocation
        function initCompassAndLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    handlePosition,
                    handleLocationError,
                    { enableHighAccuracy: true }
                );
                
                navigator.geolocation.watchPosition(
                    handlePosition,
                    handleLocationError,
                    { enableHighAccuracy: true, maximumAge: 30000, timeout: 27000 }
                );
            }
        }
        
        // Handle geolocation position
        function handlePosition(position) {
            const coords = position.coords;
            userLat = coords.latitude;
            userLon = coords.longitude;
            
            // Format coordinates like iPhone compass
            const latDMS = toDMS(userLat, true);
            const lonDMS = toDMS(userLon, false);
            document.getElementById('coordinates').textContent = `${latDMS} ${lonDMS}`;
            
            // Convert altitude from meters to feet
            const elevationFeet = coords.altitude ? Math.round(coords.altitude * 3.28084) : 0;
            document.getElementById('elevationValue').textContent = `${elevationFeet} ft Elevation`;
            
            // Reverse geocoding for location name
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLon}&zoom=18`)
                .then(response => response.json())
                .then(data => {
                    const address = data.address || {};
                    const city = address.suburb || 
                                address.city_district || 
                                address.neighbourhood || 
                                address.city || 
                                address.town || 
                                address.village || '';
                    
                    const state = address.state || address.region || '';
                    
                    let locationText = '';
                    if (city && state) {
                        locationText = `${city}, ${state}`;
                    } else if (city || state) {
                        locationText = city || state;
                    }
                    
                    // Special case for Cyberjaya
                    if (userLat >= 2.9 && userLat <= 3.0 && userLon >= 101.6 && userLon <= 101.7) {
                        locationText = locationText.includes('Sepang') ? 
                            locationText.replace('Sepang', 'Cyberjaya') : locationText;
                    }
                    
                    document.getElementById('locationValue').textContent = locationText;
                })
                .catch(err => {
                    document.getElementById('locationValue').textContent = '';
                });
        }
        
        // Handle location errors
        function handleLocationError(error) {
            console.warn('Location error:', error);
            document.getElementById('coordinates').textContent = '---';
            document.getElementById('locationValue').textContent = '';
            document.getElementById('elevationValue').textContent = '--- ft Elevation';
        }
        
        function initializeTouchPoints() {
            const touchPoints = document.querySelectorAll('.touch-point');
            
            touchPoints.forEach(point => {
                point.addEventListener('click', (e) => {
                    activateModel(e.currentTarget);
                });
                
                point.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    activateModel(e.currentTarget);
                });
            });
        }
        
        function activateModel(touchPoint) {
            const direction = touchPoint.dataset.direction;
            const modelId = `model-${direction}`;
            
            if (activeModels.has(modelId)) {
                hideModel(modelId);
                activeModels.delete(modelId);
                touchPoint.classList.remove('active', 'loading');
            } else {
                // Add to queue for large file handling
                loadQueue.push({ touchPoint, direction, modelId });
                processLoadQueue();
            }
            
            updateConnections();
        }
        
        function processLoadQueue() {
            if (isLoading || loadQueue.length === 0) return;
            
            isLoading = true;
            const { touchPoint, direction, modelId } = loadQueue.shift();
            
            // Show loading state
            touchPoint.classList.add('loading');
            document.getElementById('loadingSeed').classList.remove('hidden');
            
            // Simulate loading time for large models
            setTimeout(() => {
                showModel(direction, modelId, touchPoint);
            }, 500);
        }
        
        function showModel(direction, modelId, touchPoint) {
            const config = trigrams[direction];
            
            // 3D positions for each direction
            const positions3D = {
                north:     { x: 0,     y: 0, z: -2 },
                south:     { x: 0,     y: 0, z: 2 },
                east:      { x: 2,     y: 0, z: 0 },
                west:      { x: -2,    y: 0, z: 0 },
                northeast: { x: 1.4,   y: 0, z: -1.4 },
                northwest: { x: -1.4,  y: 0, z: -1.4 },
                southeast: { x: 1.4,   y: 0, z: 1.4 },
                southwest: { x: -1.4,  y: 0, z: 1.4 }
            };
            
            const pos3D = positions3D[direction];
            
            // Create model entity
            const model = document.createElement('a-entity');
            model.setAttribute('id', modelId);
            model.setAttribute('gltf-model', `./models/${config.model}`);
            model.setAttribute('position', '0 -0.8 0');
            model.setAttribute('scale', '0.1 0.1 0.1');
            
            scene.appendChild(model);
            
            // Wait for model to load
            model.addEventListener('model-loaded', () => {
                // Hide loading indicators
                touchPoint.classList.remove('loading');
                touchPoint.classList.add('active');
                document.getElementById('loadingSeed').classList.add('hidden');
                
                // Start growth animation
                startGrowthAnimation(model, pos3D);
                
                activeModels.add(modelId);
                updateConnections();
                
                // Process next in queue
                isLoading = false;
                processLoadQueue();
            });
            
            // Timeout for failed loads
            setTimeout(() => {
                if (touchPoint.classList.contains('loading')) {
                    touchPoint.classList.remove('loading');
                    document.getElementById('loadingSeed').classList.add('hidden');
                    isLoading = false;
                    processLoadQueue();
                }
            }, 10000);
        }
        
        function startGrowthAnimation(model, targetPos) {
            // Phase 1: Emergence from ground
            model.setAttribute('animation__grow1', {
                property: 'scale',
                from: '0.1 0.1 0.1',
                to: '0.45 0.45 0.45',
                dur: 4000,
                easing: 'easeInOutQuad'
            });
            
            model.setAttribute('animation__rise1', {
                property: 'position',
                from: '0 -0.8 0',
                to: '0 0 0',
                dur: 5000,
                easing: 'easeInOutQuad'
            });
            
            // Phase 2: Move to direction while growing
            setTimeout(() => {
                model.setAttribute('animation__spread', {
                    property: 'position',
                    from: '0 0 0',
                    to: `${targetPos.x} ${targetPos.y} ${targetPos.z}`,
                    dur: 5000,
                    easing: 'easeInOutSine'
                });
                
                model.setAttribute('animation__grow2', {
                    property: 'scale',
                    from: '0.45 0.45 0.45',
                    to: '0.8 0.8 0.8',
                    dur: 5000,
                    easing: 'easeInOutSine'
                });
            }, 5000);
            
            // Phase 3: Final animations
            setTimeout(() => {
                model.setAttribute('animation__rotate', {
                    property: 'rotation',
                    to: '0 360 0',
                    dur: 40000,
                    loop: true,
                    easing: 'linear'
                });
                
                model.setAttribute('animation__float', {
                    property: 'position',
                    from: `${targetPos.x} ${targetPos.y} ${targetPos.z}`,
                    to: `${targetPos.x} ${targetPos.y + 0.5} ${targetPos.z}`,
                    dur: 10000,
                    loop: true,
                    dir: 'alternate',
                    easing: 'easeInOutSine'
                });
            }, 10000);
        }
        
        function hideModel(modelId) {
            const model = document.getElementById(modelId);
            if (!model) return;
            
            model.removeAttribute('animation__rotate');
            model.removeAttribute('animation__float');
            
            // Shrink and move back to center
            model.setAttribute('animation__return', {
                property: 'position',
                to: '0 -0.8 0',
                dur: 2000,
                easing: 'easeInExpo'
            });
            
            model.setAttribute('animation__shrink', {
                property: 'scale',
                to: '0 0 0',
                dur: 2000,
                easing: 'easeInQuad'
            });
            
            setTimeout(() => {
                if (model && model.parentNode) {
                    model.parentNode.removeChild(model);
                }
            }, 2000);
        }
        
        function updateConnections() {
            const container = document.getElementById('connections');
            container.innerHTML = '';
            
            const activePoints = document.querySelectorAll('.touch-point.active');
            
            for (let i = 0; i < activePoints.length; i++) {
                for (let j = i + 1; j < activePoints.length; j++) {
                    createConnection(activePoints[i], activePoints[j]);
                }
            }
        }
        
        function createConnection(point1, point2) {
            const rect1 = point1.getBoundingClientRect();
            const rect2 = point2.getBoundingClientRect();
            
            const x1 = rect1.left + rect1.width / 2;
            const y1 = rect1.top + rect1.height / 2;
            const x2 = rect2.left + rect2.width / 2;
            const y2 = rect2.top + rect2.height / 2;
            
            const distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const angle = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);
            
            const connection = document.createElement('div');
            connection.className = 'mycelium-connection';
            connection.style.width = distance + 'px';
            connection.style.left = x1 + 'px';
            connection.style.top = y1 + 'px';
            connection.style.transform = `rotate(${angle}deg)`;
            
            document.getElementById('connections').appendChild(connection);
            
            setTimeout(() => {
                connection.classList.add('active');
            }, 10);
        }
    </script>
</body>
</html>
